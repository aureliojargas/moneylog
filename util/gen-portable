#!/bin/bash
# Aurelio Jargas, https://aurelio.net/moneylog/
#
# Script to join all the MoneyLog pieces in one single HTML file, making it
# portable. Settings are configured and instruction messages are added.
#
# Usage:
#	gen-portable [--lang XX] [components-to-embed]
#
# Examples:
#	gen-portable                   # Portuguese portable version
#	gen-portable --lang en         # English portable version
#
# Note:
#	The results are Windows-style line break: CR+LF


cd $(dirname "$0")

lang="pt"           # pt, en, es, ca. Use --lang to change it.

# Option --lang
if test "$1" = '--lang'
then
	lang=$2
	shift
	shift
fi

# Files
html_path="../moneylog.html"
txt_path="../sample/data-$lang.txt"

# Set $commit_id to the latest Git commit hash
source set-commit-id.sh

# This warning and instructions are for the all-in-one version only
warning='
	****************************************************************
	***                                                          ***
	***   DO NOT EDIT THIS FILE IN MS WORD, use Notepad          ***
	***   More info at https://aurelio.net/soft/moneylog/         ***
	***                                                          ***
	***   NÃO EDITE ESTE ARQUIVO NO WORD, use o Bloco de Notas   ***
	***   Mais informações em https://aurelio.net/moneylog/       ***
	***                                                          ***
	****************************************************************
'
instructions='
###################################################################
# English:                                                        #
#  - Put all your data below this box                             #
#  - Format:  YYYY-MM-DD  <tab>  Number  <tab>  Description       #
#  - Tags: Optional tags on Description: tag1,tag2|Description    #
#  - Tip: Escape special symbols: & < > becomes &amp; &lt; &gt;   #
#                                                                 #
# Português:                                                      #
#  - Coloque seu dados aqui embaixo                               #
#  - Formato:  AAAA-MM-DD  <tab>  Número  <tab>  Descrição        #
#  - Tags: Se quiser use tags na Descrição: tag1,tag2|Descrição   #
#  - Dica: Coloque os símbolos & < > como &amp; &lt; &gt;         #
#                                                                 #
###################################################################
'

# Patterns:
# <link rel="stylesheet" type="text/css" href="moneylog.css">
# <script type="text/javascript" src="moneylog.js"></script>

insert_css='
/^<link .*href="moneylog\.css"/ {
	a \
<style type="text/css">
	r ../moneylog.css
	a \
</style>
	d
}

/^<link .*href="css\/portable\.css"/ {
	a \
<style type="text/css">
	r ../css/portable.css
	a \
</style>
	d
}

/^<link .*href="css\/mobile\.css"/ {
	a \
<style type="text/css">
	r ../css/mobile.css
	a \
</style>
	d
}

/^<link .*href="css\/print\.css"/ {
	a \
<style type="text/css" media="print">
	r ../css/print.css
	a \
</style>
	d
}
'
insert_js='
/^<script .*src="moneylog\.js"/ {
	a \
<script type="text/javascript">
	r ../moneylog.js
	a \
</script>
	d
}
/^<script .*src="storage\/index\.js"/ {
	a \
<script type="text/javascript">
	r ../storage/index.js
	a \
</script>
	d
}
/^<script .*src="storage\/drivers\/html\.js"/ {
	a \
<script type="text/javascript">
	r ../storage/drivers/html.js
	a \
</script>
	d
}
/^<script .*src="storage\/drivers\/.*\.js"/ d
'
insert_txt="
/^<pre/ r $txt_path
"

echo "$insert_css $insert_js $insert_txt" > sed_script

# Warning on top
echo "$warning" > temp1
echo '5 r temp1' >> sed_script

# Do it
control_m=$(printf '\r')

sed -f sed_script "$html_path" |
	# Set language
	sed "/^var lang = 'pt';/ s/pt/$lang/" |
	# Set commit id
	sed "/^var appCommit = '';/ s/'/'$commit_id/" |
	# clean up
	sed '
		# Remove config.js call
		/^<script .* src="config.js"><\/script>/ d

		# Set the default driver.
		/defaultDriver: .filesystem.,/ s/filesystem/html/
		/var showStorageWidget = true/ s/true/false/

		# Remove closing tags at the end
		/^<\/pre>/, $ d
	' |
	# unix2dos: Remove any CR, then add one per line, becoming CR+LF
	sed "s/$control_m*$/$control_m/"

# Clean up
rm -f sed_script temp1
